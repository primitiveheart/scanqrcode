<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>手机号码</title>
		
		<!-- Add to homescreen for Chrome on Android -->
		<meta name="mobile-web-app-capable" content="yes">
		<link rel="icon" sizes="192x192" href="img/app-icon72x72@2x.png">
		
		<!-- Add to homescreen for Safari on iOS -->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="apple-mobile-web-app-title" content="Amaze UI"/>
		<link rel="apple-touch-icon-precomposed" href="img/app-icon72x72@2x.png">
		
		<!-- Tile icon for Win8 (144x144 + tile color) -->
		<meta name="msapplication-TileImage" content="img/app-icon72x72@2x.png">
		<meta name="msapplication-TileColor" content="#0e90d2">
		
		<link rel="stylesheet" href="css/amazeui.css">
		<link rel="stylesheet" href="css/app.css">
		
		
		<script language="JavaScript" src="js/jquery-3.2.1.js"></script>
		<script language="JavaScript" src="js/amazeui.js"></script>
	</head>
	<body>
		
		<form class="am-form am-form-horizontal">
			<fieldset>
				<legend>手机号码绑定</legend>
				<div class="am-form-group">
					<label for="doc-ipt-3" class="am-u-sm-3 am-form-label">手机号码</label>
				    <div class="am-u-sm-9">
				      <input type="text" id="doc-ipt-3" placeholder="请您输入手机号码" class="telephone-value">
				    </div>
				</div>
				
				<div class="am-form-group">
					<label class="am-u-sm-3 am-form-label">验证码</label>
				    <div class="am-u-sm-5">
				      <input type="text" placeholder="请输入验证码" class="certifycode" >
				    </div>
				    <div class="am-u-sm-4"> 
				    	<input type="button" class="am-btn am-btn-success" onclick="clickButton(this)" value="获取验证码"/>
				    </div>
				</div>
				
				<p>
					<a class="am-btn am-btn-success telephone-ok am-btn-block"  
			  		data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0, width: 400, height: 225}">
			  			提交
		  			</a>
				</p>
			</fieldset>
		</form>
		
		
		<div class="am-modal am-modal-confirm" tabindex="-1" id="my-confirm">
		  <div class="am-modal-dialog">
		    <div class="am-modal-hd"></div>
		    <div class="am-modal-footer">
		      <span class="am-modal-btn" data-am-modal-confirm>确定</span>
		    </div>
		  </div>
		</div>
		
		
	</body>
	
	<script language="JavaScript">
			
			function clickButton(obj){
			    var obj = $(obj);
			    obj.attr("disabled","disabled");/*按钮倒计时*/
			    var time = 60;
			    var set=setInterval(function(){
				    obj.val(--time+"(s)");
				    }, 1000);/*等待时间*/
			    setTimeout(function(){
				    obj.attr("disabled",false).val("重新获取验证码");/*倒计时*/
				    clearInterval(set);
				    }, 60000);
			}
		
			//获取url中参数
			function getUrlParam(name) {
		      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
		      var r = window.location.search.substr(1).match(reg); //匹配目标参数
		      if (r != null) return unescape(r[2]); return null; //返回参数值
		    }
		
			$(document).ready(function(){
				var url = "http://47.93.237.6:8080/wheelchair/getData.jsp";
				//这个参数应该从二维码中获取
//				var lotId = "d491c006-2681-11e8-ae1d-00163e104758";
				var lotId = getUrlParam("lotId");
				var uid = "";
				
				//验证电话号码是否有效
				$(".telephone-value").on("blur", function(){
					var telephoneValue = $(".telephone-value").val();
					var regex = /^(((13[0-9]{1})|(14[0-9]{1})|(17[0]{1})|(15[0-3]{1})|(15[5-9]{1})|(18[0-9]{1}))+\d{8})$/;
					if(telephoneValue){
						if(!regex.test(telephoneValue)){
							$("#my-confirm .am-modal-hd").html("请输入有效的电话号码");
							$("#my-confirm").modal({
								onConfirm:function(){
									$(location).attr("href", "index.html");
								}
							});
						}
					}
				})
				
				
				$(".telephone-ok").on("click", function(){
					var telephone = $(".telephone-value").val();
					if(telephone == "" || telephone == undefined){
						$("#my-confirm .am-modal-hd").html("电话号码为空，请您输入电话号码");
						$("#my-confirm").modal({
							onConfirm:function(){
								$(location).attr("href", "index.html");
							}
						});
					}else{
						var fparam = '{"usr_id":"'+ telephone+'"}'
						$.ajax({
							url:url,
							type:"POST",
							async:false,
							data:{
								fname:"registerUser",
								fparam:fparam
							},
							success:function(data){
								var jsondata = JSON.parse(data);
								if(jsondata.success == 1){
									uid = jsondata.result.usr_id;
								}
							}
							
						})
					}
					
					//跳转到menu页面中
					$(location).attr("href","menu.html?uid=" + uid + "&lotId=" + lotId);
					
				})
			})
		</script>
</html>
