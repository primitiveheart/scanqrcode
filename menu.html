<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		 <meta name="viewport" content="width=device-width, initial-scale=1">
		<title></title>
		
		<!-- Add to homescreen for Chrome on Android -->
		<meta name="mobile-web-app-capable" content="yes">
		<link rel="icon" sizes="192x192" href="img/app-icon72x72@2x.png">
		
		<!-- Add to homescreen for Safari on iOS -->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="apple-mobile-web-app-title" content="Amaze UI"/>
		<link rel="apple-touch-icon-precomposed" href="img/app-icon72x72@2x.png">
		
		<!-- Tile icon for Win8 (144x144 + tile color) -->
		<meta name="msapplication-TileImage" content="img/app-icon72x72@2x.png">
		<meta name="msapplication-TileColor" content="#0e90d2">
		
		<link rel="stylesheet" href="css/amazeui.css">
		<link rel="stylesheet" href="css/app.css">
		
		<link rel="stylesheet" href="css/mobiscroll.custom-2.6.2.min.css" />
		
		<script language="JavaScript" src="js/jquery-3.2.1.js"></script>
		<script language="JavaScript" src="js/amazeui.js"></script>
		<script language="JavaScript" src="js/date.js"></script>
		<script language="JavaScript" src="js/mobiscroll.custom-2.6.2.min.js"></script>
	
	</head>
	<body>
		
		<legend>菜单列表</legend>
		
		<div class="am-g">
			<div class="am-u-sm-6">
				<button type="button" class="am-btn am-btn-primary park"  
			  		data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0, width: 400, height: 225}">停车</button>
			</div>
			<div class="am-u-sm-6">
				<button type="button" class="am-btn am-btn-primary violation">违规举报</button>
			</div>
		</div>
		
		
		
		<div class="am-modal am-modal-confirm" tabindex="-1" id="my-confirm">
		  <div class="am-modal-dialog">
		    <div class="am-modal-hd"></div>
		    <div class="am-modal-footer">
		      <span class="am-modal-btn" data-am-modal-cancel>取消</span>
		      <span class="am-modal-btn" data-am-modal-confirm>确定</span>
		    </div>
		  </div>
		</div>
		
		<div class="am-modal am-modal-confirm" tabindex="-1" id="my-confirm-minute">
		  <div class="am-modal-dialog">
		    <div class="am-modal-hd"></div>
		    <div class="am-modal-footer">
		      <span class="am-modal-btn" data-am-modal-confirm>确定</span>
		    </div>
		  </div>
		</div>
		
		
		<input type="text" placeholder="请选择时长" class="minute-input"/>
		<div style="display: none;">
		    <select class="minute" placeholder="请您选择时长(分钟)">
	          <option value="5"><span>5</span></option>
			  <option value="10"><span>10</span></option>
			  <option value="15"><span>15</span></option>
			  <option value="20"><span>20</span></option>
			  <option value="25"><span>25</span></option>
			  <option value="30"><span>30</span></option>
	 		</select>
		</div>
	
 		
 		
				
	</body>
	
	<script language="JavaScript">
		//获取url中参数
		function getUrlParam(name) {
	      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
	      var r = window.location.search.substr(1).match(reg); //匹配目标参数
	      if (r != null) return unescape(r[2]); return null; //返回参数值
	    }

		
		$(document).ready(function(){
			var url = "http://47.93.237.6:8080/wheelchair/getData.jsp";
			var lotId = getUrlParam("lotId");
			var uid = getUrlParam("uid");
			
			$(".minute-input").hide();
		
			//违规举报
			$(".violation").on("click", function(){
				$(location).attr("href", "violation.html?uid=" + uid + "&lotId=" + lotId);
			})
			
			
			var fname = "parkingData";
			var fparam = '{"uid": "' + uid+'","lotId": "' + lotId+ '"}';
		
			//开始停车
			$(".park").on("click", function(){
				//向后台请求parkingData
				$.ajax({
					type:"post",
					url:url,
					async:false,
					data:{
						fname:fname,
						fparam:fparam
					},
					success:function(data){
						var json = JSON.parse(data);
						//成功的返回
						if(json.success == 1){
							$("#my-confirm .am-modal-hd").html(json.result.msg);
							//当前车位未被预约，是否预约?(普通用户)
							if(json.result.msg == "当前车位未被预约，是否预约并直接停车?(普通用户)"){
								//是否预约
								$("#my-confirm").modal({
									onConfirm:function(){
										$(".park").hide();
										$(".violation").hide();
										$(".minute-input").show();
									},
									onCancel:function(){
										$(location).attr("href", "menu.html?uid=" + uid + "&lotId=" + lotId);
									}
								});
								
								//请您选择时长
								$(".minute-input").on("click", function(){
									$(".minute").mobiscroll("show");
									return false;
								})
								
								var today = new Date();
								$(".minute").mobiscroll().select({
									theme:"android-ics light",
									mode:"scroller",
									display:"bottom",
									lang:"zh",
									headerText: today.Format("yyyy-MM-dd hh:mm:ss") + "-请选择时长(分钟)",
									onSet:function(obj, inst){
										$(".minute-input").val(obj.valueText);
									},
									onSelect:function(value){
										
										var t_s = today.getTime();
										if(value != "" || value != undefined){
											today.setTime(t_s+ value * 1000 * 60);
										}
										console.log(today.Format("yyyy-MM-dd hh:mm:ss"));
										
										fname = "reserveLotAndParkingByParams";
										fparam ='{"uid":"'+ uid +'","lotId":"'+ lotId + '","endTime":"'+ today.Format("yyyy-MM-dd hh:mm:ss")+'"}'; 
										
										//向后台请求reserveLotAndParkingByParams
										$.ajax({
											type:"post",
											url:url,
											async:false,
											data:{
												fname:fname,
												fparam:fparam
											},
											success:function(data){
												var json = JSON.parse(data);
												if(json.success == 1){
													$("#my-confirm-minute .am-modal-hd").html(json.result.msg);
												}
											}
										});
										
										//预约成功并停车						
										$("#my-confirm-minute").modal({
											onConfirm:function(){
												$(".park").show();
												$(".violation").show();
												$(".minute-input").hide();
												$(location).attr("href","menu.html?uid=" + uid + "&lotId=" + lotId);
											}
										});
									}
								})
							}else if(json.result.msg == "本人扫码，是否现在结束使用？"){
								fname = json.result.function;
								$("#my-confirm .am-modal-hd").html(json.result.msg);
							
								$("#my-confirm").modal({
									onConfirm:function(){
										console.log(json.result.msg);
										$.ajax({
											url:url,
											type:"post",
											async:false,
											data:{
												fname:fname,
												fparam:fparam
											},
											success:function(dataStr){
												var jsonData = JSON.parse(dataStr);
												if(jsonData.success == 1){
													$("#my-confirm-minute .am-modal-hd").html(jsonData.result.msg);
		//													$(location).attr("href","menu.html?uid=" + uid + "&lotId=" + lotId);
												}
											}
										})
										
										//成功的结束
										$("#my-confirm-minute").modal({
											onConfirm:function(){
												$(location).attr("href","menu.html?uid=" + uid + "&lotId=" + lotId);
											}
										});
								
									}
								});
								
								
							}else if(json.result.msg == "非预约者本人，当前车位被预约，用户已超时（超过起始预约时间20分钟），是否举报？"){
								$(location).attr("href", "violation.html?uid=" + uid + "&lotId=" + lotId);
							}else{
							}
						}
					}
				});
				
			})
			
				
		})
	</script>
</html>
